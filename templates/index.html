html_template = """
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNICAA - Sistema de Reserva de Mesas</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f3f4f6; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 1200px; width: 100%; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .logo { display: block; max-width: 300px; margin: 0 auto 20px auto; }
        h1 { color: #4f46e5; text-align: center; margin-bottom: 20px; }
        h2 { color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-top: 30px; }
        h3 { color: #374151; margin-top: 25px; }
        .form-section, .report-section { display: flex; flex-direction: column; gap: 20px; margin-top: 20px;}
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: 600; }
        input[type="text"], input[type="password"], input[type="date"], select { padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; width: 100%; box-sizing: border-box; }
        button { background-color: #4f46e5; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #4338ca; }
        .message { padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600; }
        .success { background-color: #d1fae5; color: #065f46; }
        .error { background-color: #fee2e2; color: #991b1b; }
        .logout-btn { background-color: #dc2626; margin-top: 20px; float: right; }
        .logout-btn:hover { background-color: #b91c1c; }
        .manager-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .room-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 15px; background-color: #f9fafb; }
        .desk-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .desk-table th, .desk-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        .desk-table th { background-color: #f0f0f0; }
        .desk-occupied { background-color: #fee2e2; }
        .desk-free { background-color: #d1fae5; }
        .nav-links { text-align: center; margin-top: 20px; }
        .cancel-btn { background-color:#e53e3e !important; font-size: 14px; padding: 5px 10px; }
    </style>
</head>
<body>
    <div class="container">
        <img src="{{ url_for('static', filename='unica_logo.png') }}" class="logo">
        <h1>UNICAA - Sistema de Reserva de Mesas</h1>

        {% if message %}
        <div class="message {{ 'success' if 'sucesso' in message|lower else 'error' }}">
            {{ message }}
        </div>
        {% endif %}

        {% if 'user_id' in session %}
            <form action="/logout" method="post" style="display: inline;">
                <button type="submit" class="logout-btn">Sair</button>
            </form>
            <h2>Bem-vindo, {{ session['user_name'] }}!
                <span style="font-size: 16px; color: #6b7280;">({{ session['user_role']|capitalize }})</span>
            </h2>

            {% if session['user_role'] == 'manager' %}
            <div class="report-section">
                <h2>Dashboard do Gestor</h2>

                <form action="{{ url_for('manager_dashboard') }}" method="get" class="form-section" style="flex-direction: row; align-items: flex-end; gap: 15px; margin-top: 10px;">
                    <div class="form-group" style="flex-grow: 1;">
                        <label for="view_date">Selecione a data para visualizar:</label>
                        <input type="date" id="view_date" name="view_date" value="{{ selected_date }}">
                    </div>
                    <button type="submit" style="padding: 10px 20px; font-size: 16px;">Visualizar</button>
                </form>

                <h3>Ocupação para: {{ selected_date }}</h3>
                <div class="manager-grid">
                    {% for room, data in manager_report.items() %}
                    <div class="room-card">
                        <h4>Sala {{ room }} ({{ data.occupied }}/{{ data.total_desks }} ocupadas)</h4>
                        <table class="desk-table">
                            <thead>
                                <tr><th>Mesa</th><th>Status</th><th>Ocupado por</th><th>Equipe</th><th>Ação</th></tr>
                            </thead>
                            <tbody>
                            {% for desk_num in range(1, data.total_desks + 1) %}
                                {% set desk_info = data.desks.get(desk_num|string) %}
                                <tr class="{{ 'desk-occupied' if desk_info else 'desk-free' }}">
                                    <td>{{ desk_num }}</td>
                                    {% if desk_info %}
                                        <td>Ocupada</td>
                                        <td>{{ desk_info.name }}</td>
                                        <td>{{ desk_info.team }}</td>
                                        <td>
                                            <form action="/manager_cancel" method="post" style="display:inline;">
                                                <input type="hidden" name="booking_id" value="{{ desk_info.booking_id }}">
                                                <button type="submit" class="cancel-btn">Cancelar</button>
                                            </form>
                                        </td>
                                    {% else %}
                                        <td>Livre</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="report-section">
                    <h2>Gerenciamento de Usuários</h2>
                    <table class="desk-table">
                        <thead>
                            <tr><th>ID de Usuário</th><th>Nome</th><th>Equipe</th><th>Cargo</th><th>Ação</th></tr>
                        </thead>
                        <tbody>
                        {% for user_id, user_data in all_users.items() %}
                            <tr>
                                <td>{{ user_id }}</td>
                                <td>{{ user_data.name }}</td>
                                <td>{{ user_data.team }}</td>
                                <td>{{ user_data.role|capitalize }}</td>
                                <td>
                                    <form action="/delete_user" method="post" onsubmit="return confirm('Tem certeza que deseja EXCLUIR este usuário e TODAS as suas reservas? Esta ação não pode ser desfeita.');">
                                        <input type="hidden" name="user_id_to_delete" value="{{ user_id }}">
                                        <button type="submit" class="cancel-btn">Excluir</button>
                                    </form>
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="5">Nenhum outro usuário encontrado.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
                <div class="form-section">
                    <h2>Reservar Minha Mesa</h2>
                    <form action="/reserve" method="post">
                        <div class="form-group">
                            <label for="date">Data:</label>
                            <input type="date" id="date" name="date" required min="{{ min_date }}" max="{{ max_date }}">
                        </div>
                        <div class="form-group">
                            <label for="room">Sala:</label>
                            <select id="room" name="room" required>
                                <option value="">Selecione a sala</option>
                                {% for room_name in rooms %}
                                    <option value="{{ room_name }}">{{ room_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="desk">Mesa (1-20):</label>
                            <select id="desk" name="desk" required>
                                {% for i in range(1, 21) %}
                                <option value="{{i}}">{{i}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit">Fazer Reserva</button>
                    </form>
                </div>
                <div class="report-section">
                    <h2>Minhas Reservas</h2>
                    <table class="desk-table">
                        <thead><tr><th>Data</th><th>Sala</th><th>Mesa</th><th>Ação</th></tr></thead>
                        <tbody>
                        {% for booking in my_bookings %}
                            <tr>
                                <td>{{ booking.date }}</td>
                                <td>{{ booking.room }}</td>
                                <td>{{ booking.desk }}</td>
                                <td>
                                    <form action="/cancel" method="post" style="display:inline;">
                                        <input type="hidden" name="booking_id" value="{{ booking.id }}">
                                        <button type="submit" class="cancel-btn">Cancelar</button>
                                    </form>
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="4">Você ainda não tem reservas.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}

        {% else %}
            {% if show_register_form %}
                <div class="form-section">
                    <h2>Cadastrar Nova Conta</h2>
                    <form action="/register" method="post">
                        <div class="form-group"><label for="reg_name">Nome:</label><input type="text" id="reg_name" name="name" required></div>
                        <div class="form-group"><label for="reg_user_id">ID de Usuário:</label><input type="text" id="reg_user_id" name="user_id" required></div>
                        <div class="form-group"><label for="reg_team">Setor/Equipe:</label><input type="text" id="reg_team" name="team" required></div>
                        <div class="form-group"><label for="reg_password">Senha:</label><input type="password" id="reg_password" name="password" required></div>
                        <div class="form-group"><label for="reg_confirm_password">Confirme a Senha:</label><input type="password" id="reg_confirm_password" name="confirm_password" required></div>
                        <div class="form-group"><label for="reg_manager_code">Código de Gestor (Opcional):</label><input type="password" id="reg_manager_code" name="manager_code"></div>
                        <button type="submit">Cadastrar</button>
                    </form>
                    <div class="nav-links">
                        <a href="/">Voltar para o Login</a>
                    </div>
                </div>
            {% else %}
                <div class="form-section">
                    <h2>Login</h2>
                    <form action="/login" method="post">
                        <div class="form-group"><label for="login_user_id">ID de Usuário:</label><input type="text" id="login_user_id" name="user_id" required></div>
                        <div class="form-group"><label for="login_password">Senha:</label><input type="password" id="login_password" name="password" required></div>
                        <button type="submit">Entrar</button>
                    </form>
                    <div class="nav-links">
                        <a href="/register_page">Novo Cadastro</a>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    </div>
</body>
</html>
"""